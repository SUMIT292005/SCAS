{% extends "base.html" %}

{% block head %}
<script>
const stateData = {{ state_region_soil|tojson|safe }};
const districts = {{ districts|tojson|safe }};

document.addEventListener("DOMContentLoaded", function() {
    // Initialize all functionality
    initializeAutoFillToggles();
    initializeFormValidation();
    initializeRainfallCalculation();
    
    // Add entrance animations
    document.querySelector('.page-header').classList.add('slide-in-left');
    document.querySelector('.prediction-form').classList.add('slide-in-up');
    
    // Add animations to results if they exist
    const resultsSection = document.querySelector('.results-section');
    if (resultsSection) {
        resultsSection.classList.add('fade-in');
    }
});

// ===== Region & Soil Auto-fill =====
function initializeAutoFillToggles() {
    const autoFillRegionSoil = document.getElementById('autoFillRegionSoil');
    const stateRow = document.getElementById('stateRow');
    const stateSelect = document.getElementById('state');
    const regionSelect = document.getElementById('region');
    const soilSelect = document.getElementById('soil');

    function updateRegionSoilVisibility() {
        const toggle = document.querySelector('.region-soil-toggle');
        if(autoFillRegionSoil.checked){
            stateRow.style.display='flex';
            stateRow.classList.add('fade-in-slide');
            regionSelect.disabled=true;
            soilSelect.disabled=true;
            toggle.classList.add('active');
            showNotification("Auto-fill enabled for Region & Soil", "success");
        } else {
            stateRow.style.display='none';
            regionSelect.disabled=false;
            soilSelect.disabled=false;
            toggle.classList.remove('active');
            // Clear auto-filled values
            regionSelect.value='';
            soilSelect.value='';
        }
        updateSubmitButton();
    }

    function autoFillRegionSoilFields() {
        const selectedState = stateSelect.value;
        if (!selectedState) return;
        
        // Add loading state
        regionSelect.classList.add('loading');
        soilSelect.classList.add('loading');
        
        setTimeout(() => {
            const row = stateData.find(r => r.State===selectedState);
            if(row){
                animateValueChange(regionSelect, row.Region);
                animateValueChange(soilSelect, row.Soil_Type);
                showNotification(`Loaded data for ${selectedState}`, "success");
            } else {
                regionSelect.value='';
                soilSelect.value='';
                showNotification("No data found for selected state", "error");
            }
            
            regionSelect.classList.remove('loading');
            soilSelect.classList.remove('loading');
            updateSubmitButton();
        }, 500);
    }

    // Set up event listeners for Region & Soil auto-fill
    autoFillRegionSoil.addEventListener('change', function() {
        updateRegionSoilVisibility();
        if(autoFillRegionSoil.checked) autoFillRegionSoilFields();
    });
    
    stateSelect.addEventListener('change', autoFillRegionSoilFields);
    
    // Initialize visibility on page load
    updateRegionSoilVisibility();

    // ===== Weather Auto-fill =====
    const autoFillWeather = document.getElementById('autoFillWeather');
    const districtRow = document.getElementById('districtRow');
    const districtSelect = document.getElementById('district');
    const tempInput = document.getElementById('temp');
    const rainfallInput = document.getElementById('rainfall');

    function updateWeatherVisibility() {
        const toggle = document.querySelector('.weather-toggle');
        if(autoFillWeather.checked){
            districtRow.style.display='flex';
            districtRow.classList.add('fade-in-slide');
            tempInput.readOnly=true;
            rainfallInput.readOnly=true;
            toggle.classList.add('active');
            showNotification("Auto-fill enabled for Weather", "success");
        } else {
            districtRow.style.display='none';
            tempInput.readOnly=false;
            rainfallInput.readOnly=false;
            toggle.classList.remove('active');
        }
        updateSubmitButton();
    }

    async function autoFillWeatherFields() {
        const district = districtSelect.value;
        if(!district) return;
        
        // Add loading states
        tempInput.classList.add('loading');
        rainfallInput.classList.add('loading');
        
        try{
            const response = await fetch(`/get_weather/${district}`);
            const data = await response.json();
            
            setTimeout(() => {
                if(data.temperature) {
                    animateValueChange(tempInput, data.temperature);
                }
                if(data.rainfall) {
                    animateValueChange(rainfallInput, data.rainfall);
                    setPerDayRainfall(data.rainfall);
                }
                
                tempInput.classList.remove('loading');
                rainfallInput.classList.remove('loading');
                showNotification(`Weather data loaded for ${district}`, "success");
                updateSubmitButton();
            }, 600);
            
        } catch(err) {
            console.error("Weather fetch error:",err);
            tempInput.classList.remove('loading');
            rainfallInput.classList.remove('loading');
            showNotification("Error loading weather data", "error");
        }
    }

    // Set up event listeners for Weather auto-fill
    autoFillWeather.addEventListener('change', updateWeatherVisibility);
    districtSelect.addEventListener('change', autoFillWeatherFields);
    
    // Initialize visibility on page load
    updateWeatherVisibility();
}

// ===== Fixed Dynamic Rainfall Calculation =====
function initializeRainfallCalculation() {
    const rainfallInput = document.getElementById('rainfall');
    const daysInput = document.getElementById('days');

    window.setPerDayRainfall = function(value) {
        rainfallInput.dataset.perDay = value;
        updateTotalRainfall();
    }

    function updateTotalRainfall() {
        let perDayRainfall;
        
        // Get per-day rainfall value
        if (rainfallInput.readOnly && rainfallInput.dataset.perDay) {
            // Auto-fill mode: use stored per-day value
            perDayRainfall = parseFloat(rainfallInput.dataset.perDay);
        } else {
            // Manual mode: use current input value as per-day rainfall
            perDayRainfall = parseFloat(rainfallInput.value);
        }
        
        const days = parseFloat(daysInput.value);
        
        // Apply multiplication logic for BOTH auto-fill and manual input
        if (!isNaN(perDayRainfall) && !isNaN(days)) {
            const totalRainfall = (perDayRainfall * days).toFixed(2);
            
            // Only animate the change if it's different from current value
            if (rainfallInput.value !== totalRainfall) {
                animateValueChange(rainfallInput, totalRainfall);
            }
        }
        
        updateSubmitButton();
    }

    // Initialize per-day rainfall on page load
    if (rainfallInput.value) {
        rainfallInput.dataset.perDay = rainfallInput.value;
    }

    // Recalculate when Days_to_Harvest changes
    daysInput.addEventListener('input', updateTotalRainfall);
    
    // Recalculate when rainfall changes (for manual input)
    rainfallInput.addEventListener('input', function() {
        if (!rainfallInput.readOnly) {
            // In manual mode, treat input as per-day rainfall
            updateTotalRainfall();
        }
    });
    
    // Add input listeners for form validation
    document.querySelectorAll('.enhanced-input, .enhanced-select').forEach(input => {
        input.addEventListener('change', updateSubmitButton);
        input.addEventListener('input', updateSubmitButton);
    });
}

// ===== Form Validation =====
function initializeFormValidation() {
    const form = document.querySelector('form');
    form.addEventListener('submit', handleFormSubmit);
}

function updateSubmitButton() {
    const submitBtn = document.querySelector('.submit-btn');
    const requiredFields = [
        'region', 'soil', 'crop', 'weather', 'rainfall', 'temp', 'days'
    ];
    
    let allFilled = true;
    requiredFields.forEach(fieldName => {
        const field = document.getElementById(fieldName) || document.querySelector(`[name="${fieldName}"]`);
        if (field && !field.value) {
            allFilled = false;
        }
    });
    
    if (allFilled) {
        submitBtn.disabled = false;
        submitBtn.classList.add('ready');
        submitBtn.innerHTML = '<i class="fas fa-chart-line"></i> Predict Yield';
    } else {
        submitBtn.disabled = true;
        submitBtn.classList.remove('ready');
        submitBtn.innerHTML = '<i class="fas fa-seedling"></i> Complete All Fields';
    }
}

function handleFormSubmit(e) {
    const submitBtn = e.target.querySelector('.submit-btn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-brain fa-spin"></i> Analyzing crop data...';
    
    // Form will submit normally, this is just for visual feedback
    setTimeout(() => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }, 5000);
}

// ===== Utility Functions =====
function animateValueChange(input, newValue) {
    input.classList.add('value-changing');
    setTimeout(() => {
        input.value = newValue;
        input.classList.remove('value-changing');
        input.classList.add('value-updated');
        setTimeout(() => input.classList.remove('value-updated'), 1000);
    }, 200);
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// ===== Toggle Click Handlers =====
function toggleRegionSoil() {
    const checkbox = document.getElementById('autoFillRegionSoil');
    checkbox.checked = !checkbox.checked;
    checkbox.dispatchEvent(new Event('change'));
}

function toggleWeather() {
    const checkbox = document.getElementById('autoFillWeather');
    checkbox.checked = !checkbox.checked;
    checkbox.dispatchEvent(new Event('change'));
}
</script>

<style>
  .page-header {
    background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 30px rgba(0, 255, 127, 0.5);
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 40px;
    text-align: center;
    animation: titleGlow 2s ease-in-out infinite alternate;
  }
  
  @keyframes titleGlow {
    0% { filter: drop-shadow(0 0 10px rgba(0, 255, 127, 0.5)); }
    100% { filter: drop-shadow(0 0 20px rgba(0, 255, 127, 0.8)); }
  }
  
  .prediction-form {
    background: rgba(26, 31, 53, 0.8);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 255, 127, 0.3);
    border-radius: 20px;
    padding: 40px;
    position: relative;
    overflow: hidden;
    margin-bottom: 30px;
  }
  
  .prediction-form::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 10% 20%, rgba(0, 255, 127, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%);
    z-index: -1;
  }
  
  .form-section {
    margin-bottom: 30px;
  }
  
  .form-section h5 {
    color: var(--accent-green);
    font-size: 1.3rem;
    font-weight: bold;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    text-shadow: 0 0 10px rgba(0, 255, 127, 0.5);
  }
  
  .form-section h5::before {
    content: '';
    width: 4px;
    height: 25px;
    background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
    border-radius: 2px;
    box-shadow: 0 0 8px var(--accent-green);
  }
  
  .form-group {
    margin-bottom: 25px;
  }
  
  .form-label {
    color: var(--text-light);
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .enhanced-input, .enhanced-select {
    background: rgba(10, 15, 28, 0.8);
    border: 2px solid rgba(0, 255, 127, 0.3);
    color: var(--text-light);
    border-radius: 10px;
    padding: 12px 15px;
    transition: all 0.3s ease;
    font-size: 1rem;
    width: 100%;
  }
  
  .enhanced-input:focus, .enhanced-select:focus {
    background: rgba(10, 15, 28, 0.9);
    border-color: var(--accent-green);
    box-shadow: 0 0 15px rgba(0, 255, 127, 0.3);
    color: var(--text-light);
    outline: none;
    transform: translateY(-2px);
  }
  
  .enhanced-input:read-only {
    background: rgba(10, 15, 28, 0.6);
    border-color: rgba(0, 255, 127, 0.2);
    cursor: not-allowed;
  }
  
  .enhanced-input:disabled, .enhanced-select:disabled {
    background: rgba(10, 15, 28, 0.5);
    border-color: rgba(0, 255, 127, 0.2);
    cursor: not-allowed;
    opacity: 0.7;
  }
  
  .enhanced-select option {
    background: var(--secondary-dark);
    color: var(--text-light);
    padding: 8px;
  }
  
  .enhanced-input.loading, .enhanced-select.loading {
    border-color: #ffa500;
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { border-color: #ffa500; }
    50% { border-color: rgba(255, 165, 0, 0.5); }
  }
  
  .value-changing {
    background: rgba(255, 165, 0, 0.2) !important;
    border-color: #ffa500 !important;
    transform: scale(1.02);
  }
  
  .value-updated {
    background: rgba(0, 255, 127, 0.2) !important;
    border-color: var(--accent-green) !important;
    box-shadow: 0 0 15px rgba(0, 255, 127, 0.4);
  }
  
  .toggle-section {
    background: rgba(0, 212, 255, 0.1);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .toggle-section:hover {
    background: rgba(0, 212, 255, 0.15);
    transform: translateX(5px);
  }
  
  .toggle-section.active {
    background: rgba(0, 212, 255, 0.15);
    border-color: var(--accent-blue);
    box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
  }
  
  .region-soil-toggle, .weather-toggle {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .custom-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--accent-blue);
    border-radius: 4px;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
    pointer-events: none;
  }
  
  .custom-checkbox:checked {
    background: var(--accent-blue);
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
  }
  
  .auto-fill-row {
    margin-top: 15px;
  }
  
  .submit-btn {
    background: linear-gradient(45deg, #666, #999);
    border: none;
    color: var(--text-light);
    font-weight: bold;
    font-size: 1.2rem;
    padding: 18px 40px;
    border-radius: 25px;
    width: 100%;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    cursor: not-allowed;
    position: relative;
    overflow: hidden;
    margin-top: 30px;
  }
  
  .submit-btn.ready {
    background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
    color: var(--primary-dark);
    cursor: pointer;
  }
  
  .submit-btn.ready::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: all 0.5s ease;
  }
  
  .submit-btn.ready:hover::before {
    left: 100%;
  }
  
  .submit-btn.ready:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 255, 127, 0.4);
  }
  
  .submit-btn:disabled {
    opacity: 0.7;
    transform: none;
  }
  
  .results-section {
    background: rgba(26, 31, 53, 0.9);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 255, 127, 0.4);
    border-radius: 20px;
    padding: 30px;
    margin-top: 30px;
    position: relative;
    overflow: hidden;
  }
  
  .results-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, var(--accent-green), var(--accent-blue), var(--accent-green));
    animation: borderGlow 2s ease-in-out infinite;
  }
  
  @keyframes borderGlow {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }
  
  .yield-result {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    padding: 25px;
    background: rgba(0, 255, 127, 0.1);
    border-radius: 15px;
    border: 1px solid rgba(0, 255, 127, 0.3);
  }
  
  .yield-icon {
    font-size: 3rem;
    color: var(--accent-green);
    animation: bounce 2s ease-in-out infinite;
  }
  
  @keyframes bounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
  }
  
  .yield-text {
    color: var(--text-light);
    font-size: 1.3rem;
  }
  
  .yield-value {
    color: var(--accent-green);
    font-size: 2rem;
    font-weight: bold;
    text-shadow: 0 0 15px rgba(0, 255, 127, 0.5);
  }
  
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(26, 31, 53, 0.95);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 255, 127, 0.3);
    border-radius: 12px;
    padding: 15px 20px;
    color: var(--text-light);
    z-index: 10000;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    display: flex;
    align-items: center;
    gap: 10px;
    max-width: 350px;
  }
  
  .notification.success {
    border-color: rgba(0, 255, 127, 0.5);
  }
  
  .notification.error {
    border-color: rgba(220, 53, 69, 0.5);
  }
  
  .notification.show {
    transform: translateX(0);
  }
  
  .notification i {
    color: var(--accent-green);
  }
  
  .notification.success i {
    color: var(--accent-green);
  }
  
  .notification.error i {
    color: #ff6b6b;
  }
  
  /* Animation Classes */
  .fade-in {
    animation: fadeIn 0.8s ease-in;
  }
  
  .slide-in-up {
    animation: slideInUp 0.6s ease-out;
  }
  
  .slide-in-left {
    animation: slideInLeft 0.6s ease-out;
  }
  
  .fade-in-slide {
    animation: fadeInSlide 0.5s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes slideInLeft {
    from { opacity: 0; transform: translateX(-50px); }
    to { opacity: 1; transform: translateX(0); }
  }
  
  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .prediction-form {
      padding: 20px;
    }
    
    .page-header {
      font-size: 2rem;
    }
    
    .toggle-section {
      padding: 15px;
    }
    
    .region-soil-toggle, .weather-toggle {
      flex-direction: column;
      text-align: center;
      gap: 8px;
    }
    
    .notification {
      right: 10px;
      left: 10px;
      max-width: none;
      transform: translateY(-100%);
    }
    
    .notification.show {
      transform: translateY(0);
    }
  }
  
  @media (max-width: 480px) {
    .page-header {
      font-size: 1.8rem;
    }
    
    .yield-result {
      flex-direction: column;
      text-align: center;
    }
    
    .yield-icon {
      font-size: 2.5rem;
    }
    
    .yield-value {
      font-size: 1.8rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="page-header">🌾 Yield Prediction</h2>

  <form method="POST" action="{{ url_for('yield_routes.yield_prediction_route') }}" class="prediction-form">
    
    <!-- Auto-fill Region & Soil Section -->
    <div class="form-section">
      <div class="toggle-section region-soil-toggle" onclick="toggleRegionSoil()">
        <input class="custom-checkbox" type="checkbox" id="autoFillRegionSoil" name="auto_fill" {% if request.form.get('auto_fill') %}checked{% endif %}>
        <label class="form-check-label" for="autoFillRegionSoil">
          <i class="fas fa-magic"></i> Auto-fill Region & Soil Data
        </label>
      </div>

      <!-- State Dropdown (shown only if Auto-fill Region & Soil is checked) -->
      <div class="row auto-fill-row" id="stateRow" style="display:none;">
        <div class="col-md-6 form-group">
          <label for="state" class="form-label">
            <i class="fas fa-map"></i> State
          </label>
          <select id="state" class="enhanced-select">
            <option value="">-- Select State --</option>
            {% for state in states %}
              <option value="{{ state }}" {% if request.form.get('State') == state %}selected{% endif %}>{{ state }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- Region & Soil Type Section -->
    <div class="form-section">
      <h5><i class="fas fa-globe-americas"></i> Location & Soil Information</h5>
      <div class="row">
        <div class="col-md-6 form-group">
          <label for="region" class="form-label">
            <i class="fas fa-map-marker-alt"></i> Region
          </label>
          <select class="enhanced-select" id="region" name="Region" required>
            <option value="">-- Select Region --</option>
            <option value="West" {% if request.form.Region == 'West' %}selected{% endif %}>🌅 West</option>
            <option value="South" {% if request.form.Region == 'South' %}selected{% endif %}>🌴 South</option>
            <option value="North" {% if request.form.Region == 'North' %}selected{% endif %}>🏔️ North</option>
            <option value="East" {% if request.form.Region == 'East' %}selected{% endif %}>🌊 East</option>
          </select>
        </div>
        <div class="col-md-6 form-group">
          <label for="soil" class="form-label">
            <i class="fas fa-mountain"></i> Soil Type
          </label>
          <select class="enhanced-select" id="soil" name="Soil_Type" required>
            <option value="">-- Select Soil Type --</option>
            <option value="Sandy" {% if request.form.Soil_Type == 'Sandy' %}selected{% endif %}>🏖️ Sandy</option>
            <option value="Clay" {% if request.form.Soil_Type == 'Clay' %}selected{% endif %}>🏺 Clay</option>
            <option value="Loam" {% if request.form.Soil_Type == 'Loam' %}selected{% endif %}>🌱 Loam</option>
            <option value="Silt" {% if request.form.Soil_Type == 'Silt' %}selected{% endif %}>💎 Silt</option>
            <option value="Peaty" {% if request.form.Soil_Type == 'Peaty' %}selected{% endif %}>🍂 Peaty</option>
            <option value="Chalky" {% if request.form.Soil_Type == 'Chalky' %}selected{% endif %}>⚪ Chalky</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Crop & Weather Section -->
    <div class="form-section">
      <h5><i class="fas fa-seedling"></i> Crop & Weather Information</h5>
      <div class="row">
        <div class="col-md-6 form-group">
          <label for="crop" class="form-label">
            <i class="fas fa-leaf"></i> Crop
          </label>
          <select class="enhanced-select" id="crop" name="Crop" required>
            <option value="">-- Select Crop --</option>
            <option value="Cotton" {% if request.form.Crop == 'Cotton' %}selected{% endif %}>🌾 Cotton</option>
            <option value="Rice" {% if request.form.Crop == 'Rice' %}selected{% endif %}>🍚 Rice</option>
            <option value="Barley" {% if request.form.Crop == 'Barley' %}selected{% endif %}>🌾 Barley</option>
            <option value="Soybean" {% if request.form.Crop == 'Soybean' %}selected{% endif %}>🌱 Soybean</option>
            <option value="Wheat" {% if request.form.Crop == 'Wheat' %}selected{% endif %}>🌾 Wheat</option>
            <option value="Maize" {% if request.form.Crop == 'Maize' %}selected{% endif %}>🌽 Maize</option>
          </select>
        </div>
        <div class="col-md-6 form-group">
          <label for="weather" class="form-label">
            <i class="fas fa-cloud-sun"></i> Weather Condition
          </label>
          <select class="enhanced-select" id="weather" name="Weather_Condition" required>
            <option value="">-- Select Weather --</option>
            <option value="Cloudy" {% if request.form.Weather_Condition == 'Cloudy' %}selected{% endif %}>☁️ Cloudy</option>
            <option value="Rainy" {% if request.form.Weather_Condition == 'Rainy' %}selected{% endif %}>🌧️ Rainy</option>
            <option value="Sunny" {% if request.form.Weather_Condition == 'Sunny' %}selected{% endif %}>☀️ Sunny</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Auto-fill Weather Section -->
    <div class="form-section">
      <div class="toggle-section weather-toggle" onclick="toggleWeather()">
        <input class="custom-checkbox" type="checkbox" id="autoFillWeather" name="auto_weather" {% if request.form.get('auto_weather') %}checked{% endif %}>
        <label class="form-check-label" for="autoFillWeather">
          <i class="fas fa-satellite-dish"></i> Auto-fill Weather Data
        </label>
      </div>

      <!-- District Dropdown (shown only if Auto-fill Weather is checked) -->
      <div class="row auto-fill-row" id="districtRow" style="display:none;">
        <div class="col-md-6 form-group">
          <label for="district" class="form-label">
            <i class="fas fa-map-marker-alt"></i> District
          </label>
          <select class="enhanced-select" id="district" name="District">
            <option value="">-- Select District --</option>
            {% for d in districts %}
              <option value="{{ d }}" {% if request.form.District == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <!-- Environmental Data Section -->
    <div class="form-section">
      <h5><i class="fas fa-thermometer-half"></i> Environmental Data</h5>
      <p class="note" style="color: white; margin-top: 5px;">
        <strong>Note:</strong> If total rainfall is known, put the days to harvest as <strong>1</strong>.
      </p>
      <div class="row">
        <div class="col-md-4 form-group">
          <label for="rainfall" class="form-label">
            <i class="fas fa-cloud-rain"></i> Rainfall (mm/day)
          </label>
          <input type="number" step="0.1" class="enhanced-input" name="Rainfall_mm" id="rainfall" 
                placeholder="Enter per-day rainfall" value="{{ request.form.Rainfall_mm }}">
        </div>
        <div class="col-md-4 form-group">
          <label for="temp" class="form-label">
            <i class="fas fa-thermometer-half"></i> Temperature (°C)
          </label>
          <input type="number" step="0.1" class="enhanced-input" name="Temperature_Celsius" id="temp" 
                 placeholder="Enter temperature" value="{{ request.form.Temperature_Celsius }}">
        </div>
        <div class="col-md-4 form-group">
          <label for="days" class="form-label">
            <i class="fas fa-calendar-alt"></i> Days to Harvest
          </label>
          <input type="number" class="enhanced-input" name="Days_to_Harvest" id="days" 
                 placeholder="Enter days" value="{{ request.form.Days_to_Harvest }}">
        </div>
      </div>
    </div>

    <!-- Agricultural Practices Section -->
    <div class="form-section">
      <h5><i class="fas fa-tools"></i> Agricultural Practices</h5>
      <div class="row">
        <div class="col-md-6 form-group">
          <label class="form-label">
            <i class="fas fa-flask"></i> Fertilizer Used
          </label>
          <select class="enhanced-select" name="Fertilizer_Used">
            <option value="True" {% if request.form.Fertilizer_Used == 'True' %}selected{% endif %}>✅ Yes</option>
            <option value="False" {% if request.form.Fertilizer_Used == 'False' %}selected{% endif %}>❌ No</option>
          </select>
        </div>
        <div class="col-md-6 form-group">
          <label class="form-label">
            <i class="fas fa-tint"></i> Irrigation Used
          </label>
          <select class="enhanced-select" name="Irrigation_Used">
            <option value="True" {% if request.form.Irrigation_Used == 'True' %}selected{% endif %}>✅ Yes</option>
            <option value="False" {% if request.form.Irrigation_Used == 'False' %}selected{% endif %}>❌ No</option>
          </select>
        </div>
      </div>
    </div>

    <button type="submit" class="submit-btn" disabled>
      <i class="fas fa-seedling"></i> Complete All Fields
    </button>
  </form>

  {% if prediction %}
  <div class="results-section">
    <div class="yield-result">
      <div class="yield-icon">🌾</div>
      <div>
        <div class="yield-text">Predicted Yield:</div>
        <div class="yield-value">{{ prediction }} tons/ha</div>
      </div>
    </div>
    
    <div style="margin-top: 25px; padding: 20px; background: rgba(0, 212, 255, 0.1); border-radius: 12px; border: 1px solid rgba(0, 212, 255, 0.3);">
      <h6 style="color: var(--accent-blue); margin-bottom: 15px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-info-circle"></i> Prediction Insights
      </h6>
      <p style="margin: 0; color: var(--text-light); line-height: 1.6;">
        This yield prediction is based on your crop type, environmental conditions, and agricultural practices. 
        Actual yields may vary based on factors like pest management, soil health, and seasonal variations.
      </p>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
