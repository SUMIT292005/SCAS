{% extends "base.html" %}

{% block title %}🌱 Crop Recommendation{% endblock %}

{% block head %}
<script>
function selectMode(mode) {
    document.getElementById('manual-section').style.display = mode === 'manual' ? 'block' : 'none';
    document.getElementById('automatic-section').style.display = mode === 'automatic' ? 'block' : 'none';
    
    // Add visual feedback for mode selection
    const manualBtn = document.querySelector('[onclick="selectMode(\'manual\')"]');
    const autoBtn = document.querySelector('[onclick="selectMode(\'automatic\')"]');
    
    if (mode === 'manual') {
        manualBtn.classList.remove('btn-secondary');
        manualBtn.classList.add('btn-primary', 'active-mode');
        autoBtn.classList.remove('btn-primary', 'active-mode');
        autoBtn.classList.add('btn-secondary');
    } else {
        autoBtn.classList.remove('btn-secondary');
        autoBtn.classList.add('btn-primary', 'active-mode');
        manualBtn.classList.remove('btn-primary', 'active-mode');
        manualBtn.classList.add('btn-secondary');
    }
    
    updateFinalRainfall();
}

function toggleSoilDistrict() {
    var check = document.getElementById('use_average_soil').checked;
    const soilDiv = document.getElementById('soil_location_div');
    
    if (check) {
        soilDiv.style.display = 'block';
        soilDiv.classList.add('fade-in-slide');
    } else {
        soilDiv.style.display = 'none';
        // Clear any existing loader when hiding
        const existingLoader = document.getElementById('soil-loader');
        if (existingLoader) {
            existingLoader.remove();
        }
    }

    var districtSelect = document.getElementById('soil_district_select').value;
    if (check && districtSelect) fetchSoil();
}

function fetchSoil() {
    var district = document.getElementById('soil_district_select').value;
    if (!district) return;
    
    // Create a loading indicator near the soil fields instead of changing button text
    const soilContainer = document.getElementById('soil_location_div');
    const existingLoader = document.getElementById('soil-loader');
    
    // Remove existing loader if any
    if (existingLoader) {
        existingLoader.remove();
    }
    
    // Add loading indicator
    const loader = document.createElement('div');
    loader.id = 'soil-loader';
    loader.innerHTML = `
        <div class="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> 
            <span>Fetching soil data for ${district}...</span>
        </div>
    `;
    soilContainer.appendChild(loader);
    
    fetch('/get_soil/' + district)
    .then(res => res.json())
    .then(data => {
        if (!data.error) {
            const nInput = document.getElementsByName('N')[0];
            const pInput = document.getElementsByName('P')[0];
            const kInput = document.getElementsByName('K')[0];
            const phInput = document.getElementsByName('pH')[0];
            
            // Animate value changes
            animateValueChange(nInput, data.N);
            animateValueChange(pInput, data.P);
            animateValueChange(kInput, data.K);
            animateValueChange(phInput, data.pH);
            
            // Show success message
            loader.innerHTML = `
                <div class="success-indicator">
                    <i class="fas fa-check-circle"></i> 
                    <span>Soil data loaded successfully!</span>
                </div>
            `;
            
            // Remove success message after 2 seconds
            setTimeout(() => {
                if (loader && loader.parentNode) {
                    loader.remove();
                }
            }, 2000);
        } else {
            // Show error message
            loader.innerHTML = `
                <div class="error-indicator">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <span>Error loading soil data</span>
                </div>
            `;
            
            // Remove error message after 3 seconds
            setTimeout(() => {
                if (loader && loader.parentNode) {
                    loader.remove();
                }
            }, 3000);
        }
    })
    .catch((error) => {
        console.error('Soil fetch error:', error);
        loader.innerHTML = `
            <div class="error-indicator">
                <i class="fas fa-exclamation-triangle"></i> 
                <span>Network error - please try again</span>
            </div>
        `;
        
        setTimeout(() => {
            if (loader && loader.parentNode) {
                loader.remove();
            }
        }, 3000);
    });
}

function toggleWeather(option) {
    const manualWeather = document.getElementById('manual-weather');
    const apiWeather = document.getElementById('api-weather');
    
    if (option === 'manual') {
        manualWeather.style.display = 'block';
        apiWeather.style.display = 'none';
        manualWeather.classList.add('fade-in-slide');
    } else {
        manualWeather.style.display = 'none';
        apiWeather.style.display = 'block';
        apiWeather.classList.add('fade-in-slide');
    }
    updateFinalRainfall();
}

function fetchWeather() {
    var district = document.getElementById('weather_district_select').value;
    if (!district) return;

    // Create weather loading indicator
    const weatherContainer = document.getElementById('api-weather');
    const existingWeatherLoader = document.getElementById('weather-loader');
    
    if (existingWeatherLoader) {
        existingWeatherLoader.remove();
    }
    
    const weatherLoader = document.createElement('div');
    weatherLoader.id = 'weather-loader';
    weatherLoader.innerHTML = `
        <div class="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i> 
            <span>Fetching weather data for ${district}...</span>
        </div>
    `;
    weatherContainer.appendChild(weatherLoader);

    fetch('/get_weather/' + district)
        .then(res => res.json())
        .then(data => {
            if (!data.error) {
                const tempInput = document.getElementById('api_temperature');
                const humidityInput = document.getElementById('api_humidity');
                const rainfallInput = document.getElementById('api_rainfall');
                
                // Animate value changes
                animateValueChange(tempInput, parseFloat(data.temperature).toFixed(1));
                animateValueChange(humidityInput, parseFloat(data.humidity).toFixed(1));
                animateValueChange(rainfallInput, parseFloat(data.rainfall).toFixed(1));
                
                updateFinalRainfall();
                
                // Show success message
                weatherLoader.innerHTML = `
                    <div class="success-indicator">
                        <i class="fas fa-check-circle"></i> 
                        <span>Weather data loaded successfully!</span>
                    </div>
                `;
                
                setTimeout(() => {
                    if (weatherLoader && weatherLoader.parentNode) {
                        weatherLoader.remove();
                    }
                }, 2000);
            } else {
                weatherLoader.innerHTML = `
                    <div class="error-indicator">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <span>Error loading weather data</span>
                    </div>
                `;
                
                setTimeout(() => {
                    if (weatherLoader && weatherLoader.parentNode) {
                        weatherLoader.remove();
                    }
                }, 3000);
            }
        })
        .catch(() => {
            weatherLoader.innerHTML = `
                <div class="error-indicator">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <span>Network error - please try again</span>
                </div>
            `;
            
            setTimeout(() => {
                if (weatherLoader && weatherLoader.parentNode) {
                    weatherLoader.remove();
                }
            }, 3000);
        });
}

function animateValueChange(input, newValue) {
    input.classList.add('value-changing');
    setTimeout(() => {
        input.value = newValue;
        input.classList.remove('value-changing');
        input.classList.add('value-updated');
        setTimeout(() => input.classList.remove('value-updated'), 1000);
    }, 200);
}

function updateFinalRainfall() {
    let rainfall = 0;
    if (document.getElementById('manual-weather').style.display === 'block') {
        rainfall = parseFloat(document.getElementById('manual_rainfall').value) || 0;
    } else {
        rainfall = parseFloat(document.getElementById('api_rainfall').value) || 0;
    }

    let intensity = document.getElementById('rainfall_intensity').value;
    let multiplier = {"heavy":90,"mild":60,"normal":30}[intensity] || 30;

    const finalInput = document.getElementById('final_rainfall');
    const newValue = (rainfall * multiplier).toFixed(2);
    
    if (finalInput.value !== newValue) {
        animateValueChange(finalInput, newValue);
    }
}

window.onload = function() {
    selectMode('manual');

    let selectedOption = document.querySelector('input[name="weather_option"]:checked');
    if (selectedOption) toggleWeather(selectedOption.value);

    toggleSoilDistrict();

    let useAverage = document.getElementById('use_average_soil').checked;
    let selectedSoilDistrict = document.getElementById('soil_district_select').value;
    if (useAverage && selectedSoilDistrict) fetchSoil();

    let weatherDistrict = document.getElementById('weather_district_select').value;
    if (selectedOption && selectedOption.value === 'api' && weatherDistrict) fetchWeather();

    document.getElementById('rainfall_intensity').addEventListener('change', updateFinalRainfall);
    document.getElementById('manual_rainfall').addEventListener('input', updateFinalRainfall);
    document.getElementById('api_rainfall').addEventListener('input', updateFinalRainfall);

    updateFinalRainfall();
    
    // Add entrance animations
    document.querySelector('.page-header').classList.add('slide-in-left');
    document.querySelector('.mode-selector').classList.add('fade-in');
    document.querySelector('.main-form').classList.add('slide-in-up');
};
</script>

<style>
  .page-header {
    background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 30px rgba(0, 255, 127, 0.5);
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 30px;
    animation: titleGlow 2s ease-in-out infinite alternate;
  }
  
  @keyframes titleGlow {
    0% { filter: drop-shadow(0 0 10px rgba(0, 255, 127, 0.5)); }
    100% { filter: drop-shadow(0 0 20px rgba(0, 255, 127, 0.8)); }
  }
  
  .mode-selector {
    margin-bottom: 30px;
    display: flex;
    gap: 15px;
    justify-content: center;
  }
  
  .mode-btn {
    padding: 15px 30px;
    border-radius: 25px;
    border: 2px solid var(--accent-green);
    background: transparent;
    color: var(--accent-green);
    font-weight: bold;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    overflow: hidden;
  }
  
  .mode-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, var(--accent-green), transparent);
    transition: all 0.5s ease;
    opacity: 0.3;
  }
  
  .mode-btn:hover::before {
    left: 100%;
  }
  
  .mode-btn.active-mode {
    background: var(--accent-green);
    color: var(--primary-dark);
    box-shadow: 0 0 20px var(--accent-green);
    transform: scale(1.05);
  }
  
  .mode-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 255, 127, 0.3);
  }
  
  .main-form {
    background: rgba(26, 31, 53, 0.8);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 255, 127, 0.3);
    border-radius: 20px;
    padding: 40px;
    position: relative;
    overflow: hidden;
  }
  
  .main-form::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
      radial-gradient(circle at 10% 20%, rgba(0, 255, 127, 0.1) 0%, transparent 50%),
      radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%);
    z-index: -1;
  }
  
  .section-header {
    color: var(--accent-green);
    font-size: 1.4rem;
    font-weight: bold;
    margin-bottom: 25px;
    text-shadow: 0 0 10px rgba(0, 255, 127, 0.5);
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .section-header::before {
    content: '';
    width: 4px;
    height: 30px;
    background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));
    border-radius: 2px;
    box-shadow: 0 0 10px var(--accent-green);
  }
  
  .form-group {
    margin-bottom: 25px;
  }
  
  .form-label {
    color: var(--text-light);
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    font-size: 1rem;
  }
  
  .enhanced-input {
    background: rgba(10, 15, 28, 0.8);
    border: 2px solid rgba(0, 255, 127, 0.3);
    color: var(--text-light);
    border-radius: 12px;
    padding: 12px 16px;
    transition: all 0.3s ease;
    font-size: 1rem;
  }
  
  .enhanced-input:focus {
    background: rgba(10, 15, 28, 0.9);
    border-color: var(--accent-green);
    box-shadow: 0 0 20px rgba(0, 255, 127, 0.3);
    color: var(--text-light);
    transform: translateY(-2px);
  }
  
  .enhanced-input::placeholder {
    color: rgba(224, 230, 237, 0.5);
  }
  
  .value-changing {
    background: rgba(255, 165, 0, 0.2) !important;
    border-color: #ffa500 !important;
    transform: scale(1.02);
  }
  
  .value-updated {
    background: rgba(0, 255, 127, 0.2) !important;
    border-color: var(--accent-green) !important;
    box-shadow: 0 0 15px rgba(0, 255, 127, 0.4);
  }
  
  .weather-toggle {
    display: flex;
    gap: 20px;
    margin-bottom: 25px;
    padding: 20px;
    background: rgba(0, 212, 255, 0.1);
    border-radius: 15px;
    border: 1px solid rgba(0, 212, 255, 0.3);
  }
  
  .custom-radio {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 10px 15px;
    border-radius: 10px;
    transition: all 0.3s ease;
  }
  
  .custom-radio:hover {
    background: rgba(0, 212, 255, 0.2);
  }
  
  .custom-radio input[type="radio"] {
    width: 20px;
    height: 20px;
    border: 2px solid var(--accent-blue);
    background: transparent;
  }
  
  .custom-radio input[type="radio"]:checked {
    background: var(--accent-blue);
    box-shadow: 0 0 10px var(--accent-blue);
  }
  
  .checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    background: rgba(0, 255, 127, 0.1);
    border-radius: 12px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
  }
  
  .checkbox-wrapper:hover {
    background: rgba(0, 255, 127, 0.15);
  }
  
  .custom-checkbox {
    width: 22px;
    height: 22px;
    border: 2px solid var(--accent-green);
    border-radius: 6px;
    background: transparent;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .custom-checkbox:checked {
    background: var(--accent-green);
    box-shadow: 0 0 15px rgba(0, 255, 127, 0.5);
  }
  
  .submit-btn {
    background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
    border: none;
    color: var(--primary-dark);
    font-weight: bold;
    font-size: 1.2rem;
    padding: 18px 40px;
    border-radius: 25px;
    width: 100%;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    position: relative;
    overflow: hidden;
  }
  
  .submit-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: all 0.5s ease;
  }
  
  .submit-btn:hover::before {
    left: 100%;
  }
  
  .submit-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 255, 127, 0.4);
  }
  
  .submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }
  
  .summary-card, .results-card {
    background: rgba(26, 31, 53, 0.9);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(0, 255, 127, 0.4);
    border-radius: 18px;
    padding: 30px;
    margin-top: 30px;
    position: relative;
    overflow: hidden;
  }
  
  .summary-card::before, .results-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, var(--accent-green), var(--accent-blue), var(--accent-green));
    animation: borderGlow 2s ease-in-out infinite;
  }
  
  @keyframes borderGlow {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }
  
  .card-title {
    color: var(--accent-green);
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .summary-list {
    list-style: none;
    padding: 0;
  }
  
  .summary-item {
    background: rgba(10, 15, 28, 0.6);
    padding: 12px 18px;
    margin-bottom: 8px;
    border-radius: 10px;
    border-left: 4px solid var(--accent-green);
    transition: all 0.3s ease;
  }
  
  .summary-item:hover {
    background: rgba(10, 15, 28, 0.8);
    transform: translateX(5px);
  }
  
  .recommendation-list {
    counter-reset: crop-counter;
    list-style: none;
    padding: 0;
  }
  
  .recommendation-item {
    counter-increment: crop-counter;
    background: rgba(10, 15, 28, 0.6);
    padding: 15px 20px;
    margin-bottom: 12px;
    border-radius: 12px;
    border-left: 4px solid var(--accent-blue);
    position: relative;
    transition: all 0.3s ease;
  }
  
  .recommendation-item::before {
    content: counter(crop-counter);
    position: absolute;
    left: -15px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--accent-blue);
    color: var(--primary-dark);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
  }
  
  .recommendation-item:hover {
    background: rgba(10, 15, 28, 0.8);
    transform: translateX(10px);
    box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
  }
  
  .error-message {
    background: rgba(220, 53, 69, 0.2);
    border: 1px solid rgba(220, 53, 69, 0.5);
    color: #ff6b6b;
    padding: 15px 20px;
    border-radius: 12px;
    margin-top: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  /* Loading Indicators */
  .loading-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--accent-green);
    font-weight: bold;
    margin-top: 10px;
    padding: 10px;
    background: rgba(0, 255, 127, 0.1);
    border: 1px solid rgba(0, 255, 127, 0.3);
    border-radius: 8px;
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  .success-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--accent-green);
    font-weight: bold;
    margin-top: 10px;
    padding: 10px;
    background: rgba(0, 255, 127, 0.2);
    border: 1px solid rgba(0, 255, 127, 0.5);
    border-radius: 8px;
    animation: fadeIn 0.5s ease;
  }
  
  .error-indicator {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #ff6b6b;
    font-weight: bold;
    margin-top: 10px;
    padding: 10px;
    background: rgba(220, 53, 69, 0.2);
    border: 1px solid rgba(220, 53, 69, 0.5);
    border-radius: 8px;
    animation: fadeIn 0.5s ease;
  }
  
  .fade-in-slide {
    animation: fadeInSlide 0.5s ease-out;
  }
  
  .slide-in-up {
    animation: slideInUp 0.6s ease-out;
  }
  
  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
  }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    .mode-selector {
      flex-direction: column;
      align-items: center;
    }
    
    .mode-btn {
      width: 100%;
      max-width: 300px;
    }
    
    .main-form {
      padding: 20px;
    }
    
    .weather-toggle {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3">
  <h2 class="page-header text-center">🌱 Crop Recommendation</h2>

  <div class="mode-selector">
    <button type="button" class="mode-btn btn-primary active-mode" onclick="selectMode('manual')">
      <i class="fas fa-keyboard"></i> Manual Entries
    </button>
    <button type="button" class="mode-btn btn-secondary" onclick="selectMode('automatic')">
      <i class="fas fa-magic"></i> Automatic Entries
    </button>
  </div>

  <form action="{{ url_for('crop_routes.show_crop_recommendation') }}" method="POST" class="main-form">
    <!-- Manual Section -->
    <div id="manual-section">
      <h5 class="section-header">
        <i class="fas fa-edit"></i> Manual Soil & Weather Data
      </h5>

      <div class="row mb-4">
        <div class="col-md-3 form-group">
          <label class="form-label">
            <i class="fas fa-seedling"></i> Nitrogen (N):
          </label>
          <input type="number" step="0.1" name="N" class="form-control enhanced-input" 
                 placeholder="Enter N value" 
                 value="{{ input_summary.N if input_summary else '' }}" />
        </div>
        <div class="col-md-3 form-group">
          <label class="form-label">
            <i class="fas fa-atom"></i> Phosphorus (P):
          </label>
          <input type="number" step="0.1" name="P" class="form-control enhanced-input" 
                 placeholder="Enter P value"
                 value="{{ input_summary.P if input_summary else '' }}" />
        </div>
        <div class="col-md-3 form-group">
          <label class="form-label">
            <i class="fas fa-leaf"></i> Potassium (K):
          </label>
          <input type="number" step="0.1" name="K" class="form-control enhanced-input" 
                 placeholder="Enter K value"
                 value="{{ input_summary.K if input_summary else '' }}" />
        </div>
        <div class="col-md-3 form-group">
          <label class="form-label">
            <i class="fas fa-vial"></i> Soil pH:
          </label>
          <input type="number" step="0.1" name="pH" class="form-control enhanced-input" 
                 placeholder="Enter pH value"
                 value="{{ input_summary.ph if input_summary else '' }}" />
        </div>
      </div>

      <h6 class="section-header">
        <i class="fas fa-cloud"></i> Weather Data
      </h6>
      
      <div class="weather-toggle">
        <div class="custom-radio">
          <input class="form-check-input" type="radio" name="weather_option" value="manual" 
                 {% if not selected_weather_district %}checked{% endif %} 
                 onclick="toggleWeather('manual')" />
          <label class="form-check-label">
            <i class="fas fa-keyboard"></i> Manual Entry
          </label>
        </div>
        <div class="custom-radio">
          <input class="form-check-input" type="radio" name="weather_option" value="api" 
                 {% if selected_weather_district %}checked{% endif %} 
                 onclick="toggleWeather('api')" />
          <label class="form-check-label">
            <i class="fas fa-satellite-dish"></i> Fetch via API
          </label>
        </div>
      </div>

      <div id="manual-weather" class="mt-3">
        <div class="row mb-3">
          <div class="col-md-4 form-group">
            <label class="form-label">
              <i class="fas fa-thermometer-half"></i> Temperature (°C):
            </label>
            <input type="number" step="0.1" name="temperature" class="form-control enhanced-input" 
                   placeholder="Enter temperature"
                   value="{{ input_summary.temperature if input_summary else '' }}" />
          </div>
          <div class="col-md-4 form-group">
            <label class="form-label">
              <i class="fas fa-tint"></i> Humidity (%):
            </label>
            <input type="number" step="0.1" name="humidity" class="form-control enhanced-input" 
                   placeholder="Enter humidity"
                   value="{{ input_summary.humidity if input_summary else '' }}" />
          </div>
          <div class="col-md-4 form-group">
            <label class="form-label">
              <i class="fas fa-cloud-rain"></i> Rainfall (mm):
            </label>
            <input type="number" step="0.1" id="manual_rainfall" name="rainfall" 
                   class="form-control enhanced-input" placeholder="Enter rainfall"
                   value="{{ input_summary.rainfall if input_summary else '' }}" />
          </div>
        </div>
      </div>

      <div id="api-weather" class="mt-3" style="display:none;">
        <div class="form-group">
          <label class="form-label">
            <i class="fas fa-map-marker-alt"></i> Select Weather District:
          </label>
          <select id="weather_district_select" name="weather_district" 
                  class="form-select enhanced-input" onchange="fetchWeather()">
            <option value="">--Select District--</option>
            {% for district in weather_districts %}
            <option value="{{ district }}" {% if selected_weather_district == district %}selected{% endif %}>
              {{ district }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="row mt-3">
          <div class="col-md-4 form-group">
            <label class="form-label">
              <i class="fas fa-thermometer-half"></i> Temperature (°C):
            </label>
            <input type="number" step="0.1" id="api_temperature" name="temperature" 
                   class="form-control enhanced-input" readonly
                   value="{{ input_summary.temperature if input_summary else '' }}" />
          </div>
          <div class="col-md-4 form-group">
            <label class="form-label">
              <i class="fas fa-tint"></i> Humidity (%):
            </label>
            <input type="number" step="0.1" id="api_humidity" name="humidity" 
                   class="form-control enhanced-input" readonly
                   value="{{ input_summary.humidity if input_summary else '' }}" />
          </div>
          <div class="col-md-4 form-group">
            <label class="form-label">
              <i class="fas fa-cloud-rain"></i> Rainfall (mm):
            </label>
            <input type="number" step="0.1" id="api_rainfall" name="rainfall" 
                   class="form-control enhanced-input" readonly
                   value="{{ input_summary.rainfall if input_summary else '' }}" />
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-6 form-group">
          <label class="form-label">
            <i class="fas fa-cloud-showers-heavy"></i> Rainfall Intensity:
          </label>
          <select id="rainfall_intensity" name="rainfall_intensity" class="form-select enhanced-input">
            <option value="heavy" {% if input_summary["Rainfall Intensity"]=="Heavy" %}selected{% endif %}>
              Heavy Rainfall
            </option>
            <option value="mild" {% if input_summary["Rainfall Intensity"]=="Mild" %}selected{% endif %}>
              Mild Rainfall
            </option>
            <option value="normal" {% if input_summary["Rainfall Intensity"]=="Normal" %}selected{% endif %}>
              Normal Rainfall
            </option>
          </select>
        </div>
        <div class="col-md-6 form-group">
          <label class="form-label">
            <i class="fas fa-calculator"></i> Final Rainfall (mm):
          </label>
          <input type="number" step="0.1" id="final_rainfall" class="form-control enhanced-input" 
                 readonly value="{{ input_summary['Final Rainfall (mm)'] if input_summary else '' }}" />
        </div>
      </div>
    </div>

    <!-- Automatic Section -->
    <div id="automatic-section" style="display:none;">
      <h5 class="section-header">
        <i class="fas fa-magic"></i> Automatic Entries
      </h5>

      <div class="checkbox-wrapper">
        <input type="checkbox" id="use_average_soil" name="use_average_soil" 
               class="custom-checkbox" onclick="toggleSoilDistrict()" 
               {% if use_average_soil %}checked{% endif %} />
        <label for="use_average_soil" class="form-check-label">
          <i class="fas fa-chart-area"></i> Use average soil data for district
        </label>
      </div>

      <div id="soil_location_div" class="form-group" 
           style="display: {{ 'block' if use_average_soil else 'none' }};">
        <label class="form-label">
          <i class="fas fa-map-marker-alt"></i> Select Soil District:
        </label>
        <select id="soil_district_select" name="soil_district" 
                class="form-select enhanced-input" onchange="fetchSoil()">
          <option value="">--Select District--</option>
          {% for district in soil_districts %}
          <option value="{{ district }}" {% if selected_soil_district == district %}selected{% endif %}>
            {{ district }}
          </option>
          {% endfor %}
        </select>
        <!-- Loading indicator will be added here dynamically -->
      </div>
    </div>

    <hr style="border-color: rgba(0, 255, 127, 0.3); margin: 30px 0;" />
    <button type="submit" class="submit-btn">
      <i class="fas fa-seedling"></i> 🌾 Recommend Crops
    </button>
  </form>

  <!-- Input Summary -->
  {% if input_summary %}
  <div class="summary-card">
    <h5 class="card-title">
      <i class="fas fa-clipboard-list"></i> 📌 Input Summary
    </h5>
    <ul class="summary-list">
      <li class="summary-item"><strong>Soil District:</strong> {{ input_summary["Soil District"] }}</li>
      <li class="summary-item"><strong>Weather District:</strong> {{ input_summary["Weather District"] }}</li>
      <li class="summary-item"><strong>Nitrogen (N):</strong> {{ input_summary.N }}</li>
      <li class="summary-item"><strong>Phosphorus (P):</strong> {{ input_summary.P }}</li>
      <li class="summary-item"><strong>Potassium (K):</strong> {{ input_summary.K }}</li>
      <li class="summary-item"><strong>Soil pH:</strong> {{ input_summary.pH }}</li>
      <li class="summary-item"><strong>Temperature:</strong> {{ input_summary.temperature }} °C</li>
      <li class="summary-item"><strong>Humidity:</strong> {{ input_summary.humidity }} %</li>
      <li class="summary-item"><strong>Final Rainfall:</strong> {{ input_summary['Final Rainfall (mm)'] }} mm</li>
      <li class="summary-item"><strong>Rainfall Intensity:</strong> {{ input_summary["Rainfall Intensity"] }}</li>
    </ul>
  </div>
  {% endif %}

  <!-- Recommendations -->
  {% if recommendation %}
  <div class="results-card">
    <h5 class="card-title">
      <i class="fas fa-award"></i> 🌾 Recommended Crops
    </h5>
    <ol class="recommendation-list">
      {% for crop, prob in recommendation %}
        <li class="recommendation-item">
          <strong>{{ crop }}</strong> – {{ (prob*100)|round(2) }}% suitability
          <div style="margin-top: 8px;">
            <div style="background: rgba(0, 255, 127, 0.2); height: 6px; border-radius: 3px; overflow: hidden;">
              <div style="background: var(--accent-green); height: 100%; width: {{ (prob*100)|round(2) }}%; 
                          border-radius: 3px; transition: width 1s ease;"></div>
            </div>
          </div>
        </li>
      {% endfor %}
    </ol>
  </div>
  {% endif %}

  {% if error %}
  <div class="error-message">
    <i class="fas fa-exclamation-triangle"></i>
    <span>⚠️ {{ error }}</span>
  </div>
  {% endif %}
</div>
{% endblock %}